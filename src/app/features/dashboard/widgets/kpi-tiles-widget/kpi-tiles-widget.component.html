<ng-container *ngIf="data$ | async as state">
  <ng-container *ngIf="filters$ | async as filters">
    <app-widget-state
      [state]="state"
      emptyMessage="No KPI data available for the selected range"
      [context]="state.status === 'success' ? getContextString(state.data, filters) : ''"
      (retry)="onRetry()"
    >
      @if (state.status === 'success') {
        <div class="kpi-tiles">
          <div class="kpi-tile">
            <label class="kpi-label">Total Revenue</label>
            <strong class="kpi-value">
              {{ formatCurrency(state.data.kpis.total_revenue, state.data.currency) }}
            </strong>
          </div>

          <div class="kpi-tile">
            <label class="kpi-label">Average Occupancy</label>
            <strong class="kpi-value">
              {{ formatPercentage(state.data.kpis.average_occupancy) }}
            </strong>
          </div>

          <div class="kpi-tile">
            <label class="kpi-label">ADR</label>
            <strong class="kpi-value">
              {{ formatCurrency(state.data.kpis.adr, state.data.currency) }}
            </strong>
          </div>

          <div class="kpi-tile">
            <label class="kpi-label">Total Bookings</label>
            <strong class="kpi-value">
              {{ formatNumber(state.data.kpis.total_bookings) }}
            </strong>
          </div>
        </div>
      }
    </app-widget-state>
  </ng-container>
</ng-container>
